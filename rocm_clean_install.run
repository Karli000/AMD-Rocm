#!/bin/bash
LOG="rocm_setup.log"
echo "ğŸš€ ROCm Setup gestartet: $(date)" > "$LOG"

# 1ï¸âƒ£ GPU-Erkennung
echo "ğŸ® GPU-Erkennung..." | tee -a "$LOG"
GPU=$(lspci | grep VGA | grep -i AMD)
if [[ -z "$GPU" ]]; then
    echo "âŒ Keine AMD-GPU erkannt. Abbruch." | tee -a "$LOG"
    exit 1
else
    echo "âœ… GPU erkannt: $GPU" | tee -a "$LOG"
fi

# 2ï¸âƒ£ Kernel-Version prÃ¼fen (KompatibilitÃ¤t: 5.13 â€“ 6.14)
echo "ğŸ§  Kernel-Version prÃ¼fen..." | tee -a "$LOG"
KERNEL=$(uname -r | cut -d '-' -f1)
MAJOR=$(echo "$KERNEL" | cut -d '.' -f1)
MINOR=$(echo "$KERNEL" | cut -d '.' -f2)
CURRENT=$(echo "$MAJOR.$MINOR")
echo "â¡ï¸ Aktueller Kernel: $KERNEL" | tee -a "$LOG"

REQUIRED="5.13"
MAX="6.14"
if awk "BEGIN{exit !($CURRENT >= $REQUIRED && $CURRENT <= $MAX)}"; then
    echo "âœ… Kernel ist kompatibel mit ROCm ($REQUIRED â€“ $MAX)" | tee -a "$LOG"
else
    echo "âŒ Kernel auÃŸerhalb der ROCm-KompatibilitÃ¤t. Abbruch." | tee -a "$LOG"
    exit 1
fi

# 3ï¸âƒ£ PrÃ¼fe DKMS
if ! dpkg -s dkms &> /dev/null; then
    echo "ğŸ“¦ Installiere dkms..." | tee -a "$LOG"
    sudo apt install -y dkms
else
    echo "âœ… DKMS ist bereits installiert" | tee -a "$LOG"
fi

# 4ï¸âƒ£ Alte ROCm-/AMDGPU-Treiber entfernen
echo "ğŸ§¹ Entferne alte AMD-Treiber..." | tee -a "$LOG"
sudo apt remove --purge -y rocm-dkms rock-dkms amdgpu-pro amdgpu
sudo rm -f /etc/apt/sources.list.d/rocm.list
sudo apt autoremove -y

# 5ï¸âƒ£ Neue ROCm-Version installieren
echo "ğŸ“¥ Installiere neue ROCm-Version..." | tee -a "$LOG"
wget -qO - http://repo.radeon.com/rocm/rocm.gpg.key | sudo apt-key add -
echo "deb [arch=amd64] http://repo.radeon.com/rocm/apt/debian/ xenial main" | sudo tee /etc/apt/sources.list.d/rocm.list
sudo apt update
sudo apt install -y rocm-dkms

# 6ï¸âƒ£ SystemprÃ¼fung
echo "ğŸ” PrÃ¼fe GPU-Setup..." | tee -a "$LOG"
lsmod | grep amdgpu | tee -a "$LOG"
ls -l /dev/kfd | tee -a "$LOG"
dpkg -l | grep rocm | tee -a "$LOG"
dmesg | grep amdgpu | tail -n 10 | tee -a "$LOG"

echo -e "\nâœ… ROCm Setup abgeschlossen. Log-Datei gespeichert: $LOG"
