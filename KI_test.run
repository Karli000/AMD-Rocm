#!/bin/bash
LOG="KI_test.log"
echo "ğŸ§ª ROCm Komponententest mit venv gestartet: $(date)" > "$LOG"

# ğŸ“¦ Python-Version ermitteln
PY_VER=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
VENV_PKG="python${PY_VER}-venv"

# ğŸ“‹ Venv-PaketprÃ¼fung
if ! dpkg -s "$VENV_PKG" &>/dev/null; then
  echo -e "\nâŒ Das Paket $VENV_PKG ist nicht installiert!"
  echo "ğŸ”§ Bitte installiere es mit folgendem Befehl:"
  echo "    sudo apt install $VENV_PKG"
  exit 1
fi

# ğŸ§  venv einrichten + Pakete installieren
python3 -m venv ~/rocm_venv
source ~/rocm_venv/bin/activate
~/rocm_venv/bin/pip install --upgrade pip notebook tensorflow matplotlib pandas

# ğŸš€ HIP Test
echo -e "\nğŸš€ HIP Test..." | tee -a "$LOG"
hipcc --version &>/dev/null && HIP_STATUS="âœ… verfÃ¼gbar" || HIP_STATUS="âŒ fehlt"

# ğŸ“˜ Jupyter Test
echo -e "\nğŸ“˜ Jupyter Test..." | tee -a "$LOG"
~/rocm_venv/bin/jupyter --version &>/dev/null && JUPYTER_STATUS="âœ… verfÃ¼gbar" || JUPYTER_STATUS="âŒ fehlt"

# ğŸ¨ Blender Test
echo -e "\nğŸ¨ Blender Test..." | tee -a "$LOG"
blender --version &>/dev/null && BLENDER_STATUS="âœ… verfÃ¼gbar" || BLENDER_STATUS="âŒ fehlt"

# ğŸ§  TensorFlow Test
echo -e "\nğŸ§  TensorFlow Test..." | tee -a "$LOG"
~/rocm_venv/bin/python -c "import tensorflow" &>/dev/null && TENSORFLOW_STATUS="âœ… verfÃ¼gbar" || TENSORFLOW_STATUS="âŒ fehlt"

# ğŸ“Š Komponententabelle
echo -e "\nğŸ“Š Komponententabelle:" | tee -a "$LOG"
TABLE=$(cat <<TAB
| Komponente   | Funktionstest         | Status             |
|--------------|-----------------------|--------------------|
| HIP          | hipcc --version       | ${HIP_STATUS}      |
| Jupyter      | CLI-Versionstest      | ${JUPYTER_STATUS}  |
| Blender      | blender --version     | ${BLENDER_STATUS}  |
| TensorFlow   | Import im venv        | ${TENSORFLOW_STATUS}|
TAB
)

echo -e "\nğŸ§¾ Zusammenfassung:\n$TABLE" | tee -a "$LOG"
echo -e "\nâœ… Test abgeschlossen! Ergebnisse gespeichert in $LOG"
