#!/bin/bash
# gpu_diag.run v1.1 – RDNA2 GPU-Diagnose für ROCm-Umgebungen 🧪

LOGFILE="gpu_diag_$(date +%Y%m%d_%H%M%S).log"

echo -e "\e[1;36m=== RDNA2 GPU Diagnose Tool v1.1 ===\e[0m"
echo "Systemzeit: $(date)"
echo "--------------------------------"

# Prüfe, ob lm-sensors installiert ist
if ! command -v sensors &> /dev/null; then
  echo -e "\e[1;33mℹ️ 'sensors' nicht gefunden – zum Installieren: sudo apt install lm-sensors\e[0m"
else
  echo -e "\e[1;32m✅ sensors verfügbar\e[0m"
fi

# Prüfe, ob debugfs gemountet ist
if ! mount | grep -q debugfs; then
  echo -e "\e[1;33mℹ️ 'debugfs' ist nicht gemountet – kannst du aktivieren mit:\n  sudo mount -t debugfs none /sys/kernel/debug\e[0m"
else
  echo -e "\e[1;32m✅ debugfs ist aktiv\e[0m"
fi

# Temperatur & Lüfterdaten
echo -e "\n\e[1;34m🌡️ Temperatur & Lüfterdaten:\e[0m"
for file in /sys/class/hwmon/hwmon*/temp*_input; do
  value=$(cat "$file")
  echo "  $(basename "$file"): $((value/1000))°C"
done

for fan in /sys/class/hwmon/hwmon*/fan*_input; do
  value=$(cat "$fan")
  echo "  $(basename "$fan"): $value RPM"
done

# ROCm-SMI Ausgabe
echo -e "\n\e[1;34m📦 ROCm-SMI Status:\e[0m"
rocm-smi | grep -v "^=" | grep -v "^$"

# amdgpu_pm_info
echo -e "\n\e[1;34m⚡ AMDGPU PM Info:\e[0m"
sudo cat /sys/kernel/debug/dri/0/amdgpu_pm_info 2>/dev/null || echo -e "\e[1;33mNicht verfügbar oder nicht gemountet\e[0m"

# sensors-Ausgabe
echo -e "\n\e[1;34m🧭 sensors-Ausgabe:\e[0m"
if command -v sensors &> /dev/null; then
  sensors | grep -E 'edge|temp|fan|RPM'
else
  echo "Keine sensors-Ausgabe verfügbar"
fi

echo -e "\n\e[1;32m✅ Diagnose abgeschlossen.\e[0m Du kannst die Ausgabe speichern mit:"
echo "  ./gpu_diag.run | tee $LOGFILE"
