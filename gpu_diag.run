#!/bin/bash
# gpu_diag.run v1.2 â€“ RDNA2 Diagnose mit ROCm, auto-install & sensor-check ðŸ§ 

LOGFILE="gpu_diag_$(date +%Y%m%d_%H%M%S).log"

echo -e "\e[1;36m=== RDNA2 GPU Diagnose Tool v1.2 ===\e[0m"
echo "Systemzeit: $(date)"
echo "--------------------------------"

# Root-Check
if [[ $EUID -ne 0 ]]; then
  echo -e "\e[1;31mâš ï¸ Bitte mit 'sudo' ausfÃ¼hren fÃ¼r vollstÃ¤ndige Diagnose.\e[0m"
fi

# lm-sensors prÃ¼fen + installieren
if ! command -v sensors &> /dev/null; then
  echo -e "\e[1;33mâž• 'lm-sensors' wird installiert...\e[0m"
  apt update && apt install -y lm-sensors
  yes | sensors-detect
fi

# debugfs mounten falls nÃ¶tig
if ! mount | grep -q debugfs; then
  echo -e "\e[1;33mâž• debugfs wird gemountet...\e[0m"
  mount -t debugfs none /sys/kernel/debug
fi

# Temperatur & LÃ¼fter auslesen
echo -e "\n\e[1;34mðŸŒ¡ï¸ Temperatur & LÃ¼fter:\e[0m"
for file in /sys/class/hwmon/hwmon*/temp*_input; do
  [[ -f "$file" ]] && value=$(cat "$file") && echo "  $(basename "$file"): $((value/1000))Â°C"
done
for fan in /sys/class/hwmon/hwmon*/fan*_input; do
  [[ -f "$fan" ]] && value=$(cat "$fan") && echo "  $(basename "$fan"): $value RPM"
done

# ROCm-SMI ausfÃ¼hren
echo -e "\n\e[1;34mðŸ“¦ ROCm-SMI:\e[0m"
command -v rocm-smi &> /dev/null && rocm-smi | grep -v "^=" || echo "'rocm-smi' nicht gefunden."

# amdgpu_pm_info anzeigen
echo -e "\n\e[1;34mâš¡ amdgpu_pm_info:\e[0m"
[[ -f /sys/kernel/debug/dri/0/amdgpu_pm_info ]] && cat /sys/kernel/debug/dri/0/amdgpu_pm_info || echo "Nicht verfÃ¼gbar."

# sensors-Ausgabe
echo -e "\n\e[1;34mðŸ§­ sensors:\e[0m"
sensors | grep -E 'edge|temp|fan|RPM' || echo "Keine sensors-Daten"

# Log-Hinweis
echo -e "\n\e[1;32mâœ… Diagnose abgeschlossen.\e[0m Ausgabe speichern mit:"
echo "  ./gpu_diag.run | tee $LOGFILE"
