#!/bin/bash
# gpu_diag.run v1.1 â€“ RDNA2 GPU-Diagnose fÃ¼r ROCm-Umgebungen ðŸ§ª

LOGFILE="gpu_diag_$(date +%Y%m%d_%H%M%S).log"

echo -e "\e[1;36m=== RDNA2 GPU Diagnose Tool v1.1 ===\e[0m"
echo "Systemzeit: $(date)"
echo "--------------------------------"

# PrÃ¼fe, ob lm-sensors installiert ist
if ! command -v sensors &> /dev/null; then
  echo -e "\e[1;33mâ„¹ï¸ 'sensors' nicht gefunden â€“ zum Installieren: sudo apt install lm-sensors\e[0m"
else
  echo -e "\e[1;32mâœ… sensors verfÃ¼gbar\e[0m"
fi

# PrÃ¼fe, ob debugfs gemountet ist
if ! mount | grep -q debugfs; then
  echo -e "\e[1;33mâ„¹ï¸ 'debugfs' ist nicht gemountet â€“ kannst du aktivieren mit:\n  sudo mount -t debugfs none /sys/kernel/debug\e[0m"
else
  echo -e "\e[1;32mâœ… debugfs ist aktiv\e[0m"
fi

# Temperatur & LÃ¼fterdaten
echo -e "\n\e[1;34mðŸŒ¡ï¸ Temperatur & LÃ¼fterdaten:\e[0m"
for file in /sys/class/hwmon/hwmon*/temp*_input; do
  value=$(cat "$file")
  echo "  $(basename "$file"): $((value/1000))Â°C"
done

for fan in /sys/class/hwmon/hwmon*/fan*_input; do
  value=$(cat "$fan")
  echo "  $(basename "$fan"): $value RPM"
done

# ROCm-SMI Ausgabe
echo -e "\n\e[1;34mðŸ“¦ ROCm-SMI Status:\e[0m"
rocm-smi | grep -v "^=" | grep -v "^$"

# amdgpu_pm_info
echo -e "\n\e[1;34mâš¡ AMDGPU PM Info:\e[0m"
sudo cat /sys/kernel/debug/dri/0/amdgpu_pm_info 2>/dev/null || echo -e "\e[1;33mNicht verfÃ¼gbar oder nicht gemountet\e[0m"

# sensors-Ausgabe
echo -e "\n\e[1;34mðŸ§­ sensors-Ausgabe:\e[0m"
if command -v sensors &> /dev/null; then
  sensors | grep -E 'edge|temp|fan|RPM'
else
  echo "Keine sensors-Ausgabe verfÃ¼gbar"
fi

echo -e "\n\e[1;32mâœ… Diagnose abgeschlossen.\e[0m Du kannst die Ausgabe speichern mit:"
echo "  ./gpu_diag.run | tee $LOGFILE"
