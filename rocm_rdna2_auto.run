#!/bin/bash
LOG="rocm_setup.log"
echo "ğŸš€ ROCm Setup gestartet: $(date)" > "$LOG"

# ğŸ¯ Ubuntu & Kernel-Version erkennen
UBUNTU=$(lsb_release -rs)
KERNEL=$(uname -r | cut -d '-' -f1)
MAJOR=$(echo "$KERNEL" | cut -d '.' -f1)
MINOR=$(echo "$KERNEL" | cut -d '.' -f2)
CURRENT=$(echo "$MAJOR.$MINOR")

# ğŸ§  ROCm-Version je nach System wÃ¤hlen
ROCM_VERSION=""
if [[ "$UBUNTU" == "20.04" ]]; then
  ROCM_VERSION="5.7"
elif [[ "$UBUNTU" == "22.04" && "$CURRENT" < "6.3" ]]; then
  ROCM_VERSION="6.0"
elif [[ "$UBUNTU" == "22.04" && "$CURRENT" >= "6.3" ]]; then
  ROCM_VERSION="6.1"
elif [[ "$UBUNTU" == "24.04" && "$CURRENT" < "6.15" ]]; then
  ROCM_VERSION="6.1"
else
  ROCM_VERSION="6.1"  # Fallback auch fÃ¼r 24.04.2 mit 6.14.x
  echo "âš ï¸ Unbekannte Kombination: Ubuntu $UBUNTU + Kernel $CURRENT â€“ fallback auf ROCm $ROCM_VERSION" | tee -a "$LOG"
fi

echo "ğŸ“¦ Verwende ROCm Version: $ROCM_VERSION fÃ¼r Ubuntu $UBUNTU + Kernel $CURRENT" | tee -a "$LOG"

# ğŸ§¹ Alte ROCm/AMDGPU-Treiber entfernen
sudo apt purge -y rocm-dkms amdgpu-pro amdgpu
sudo rm -f /etc/apt/sources.list.d/rocm.list
sudo apt autoremove -y | tee -a "$LOG"

# ğŸ“š ROCm-Repository hinzufÃ¼gen
echo "deb [arch=amd64] https://repo.radeon.com/rocm/apt/$ROCM_VERSION/ ubuntu main" | sudo tee /etc/apt/sources.list.d/rocm.list
wget -qO - https://repo.radeon.com/rocm/rocm.gpg.key | sudo apt-key add -
sudo apt update

# ğŸ“¥ ROCm-Komponenten installieren
sudo apt install -y rocm-dev hipcc clinfo rocminfo dkms

# ğŸ”— Kernelmodul laden
sudo modprobe amdgpu

# ğŸ§¬ Umgebungsvariablen + HSA Override
export ROCM_PATH=/opt/rocm
export PATH=$ROCM_PATH/bin:$PATH
export LD_LIBRARY_PATH=$ROCM_PATH/lib:$ROCM_PATH/lib64:$LD_LIBRARY_PATH
export DEVICE_LIB_PATH=$ROCM_PATH/lib/amdgcn/bitcode
export HSA_OVERRIDE_GFX_VERSION=10.3.0

# ğŸ”’ In .bashrc dauerhaft speichern
if ! grep -q "ROCm Setup" ~/.bashrc; then
  echo -e "\n# ROCm Setup" >> ~/.bashrc
  echo "export ROCM_PATH=/opt/rocm" >> ~/.bashrc
  echo "export PATH=\$ROCM_PATH/bin:\$PATH" >> ~/.bashrc
  echo "export LD_LIBRARY_PATH=\$ROCM_PATH/lib:\$ROCM_PATH/lib64:\$LD_LIBRARY_PATH" >> ~/.bashrc
  echo "export DEVICE_LIB_PATH=\$ROCM_PATH/lib/amdgcn/bitcode" >> ~/.bashrc
  echo "export HSA_OVERRIDE_GFX_VERSION=10.3.0" >> ~/.bashrc
fi

# ğŸ”„ Variablen sofort aktivieren
source ~/.bashrc
echo "âœ… Umgebungsvariablen aktiv!" | tee -a "$LOG"

# ğŸ§ª OpenCL-Test
echo -e "\nğŸ” OpenCL-Test:" | tee -a "$LOG"
clinfo | tee -a "$LOG"

# ğŸ§ª rocminfo
echo -e "\nğŸ” rocminfo:" | tee -a "$LOG"
rocminfo | tee -a "$LOG"

# ğŸ§¾ Zusammenfassung
echo -e "\nâœ… ROCm Setup abgeschlossen mit Version $ROCM_VERSION" | tee -a "$LOG"
