#!/bin/bash

LOG="rocm_precheck.log"
echo "üß™ ROCm Precheck gestartet: $(date)" > "$LOG"

# üü¢ Systeminfos erfassen
UBUNTU=$(lsb_release -rs)
KERNEL=$(uname -r | cut -d '-' -f1)
MAJOR=$(echo "$KERNEL" | cut -d '.' -f1)
MINOR=$(echo "$KERNEL" | cut -d '.' -f2)
CURRENT="$MAJOR.$MINOR"

echo "Ubuntu-Version: $UBUNTU" | tee -a "$LOG"
echo "Kernel-Version: $CURRENT" | tee -a "$LOG"

# ‚úÖ ROCm-Kompatibilit√§t pr√ºfen
COMPAT=false
if [[ "$UBUNTU" == "22.04" && ( "$CURRENT" == "5.15" || "$CURRENT" == "6.8" ) ]]; then
    COMPAT=true
elif [[ "$UBUNTU" == "24.04" && ( "$CURRENT" == "6.8" || "$CURRENT" == "6.14" ) ]]; then
    COMPAT=true
fi

if [ "$COMPAT" = true ]; then
    echo "‚úÖ Ubuntu $UBUNTU + Kernel $CURRENT sind mit ROCm kompatibel!" | tee -a "$LOG"
else
    echo "‚ùå Kombination aus Ubuntu $UBUNTU + Kernel $CURRENT ist NICHT offiziell unterst√ºtzt!" | tee -a "$LOG"
fi

# üéÆ GPU-Erkennung
echo "üîç GPU-Erkennung:" | tee -a "$LOG"
GPU_NAME=$(lspci | grep VGA | grep -i amd)
echo "$GPU_NAME" | tee -a "$LOG"

if [[ "$GPU_NAME" == *"6600 XT"* || "$GPU_NAME" == *"Navi 23"* ]]; then
    echo "‚úÖ AMD RX 6600 XT erkannt ‚Äì Architektur gfx1032 (ROCm-f√§hig)" | tee -a "$LOG"
else
    echo "‚ö†Ô∏è Keine RX 6600 XT erkannt ‚Äì manuelle Pr√ºfung der ROCm-Kompatibilit√§t empfohlen" | tee -a "$LOG"
fi

# üõ†Ô∏è System aktualisieren
echo "üì¶ System wird aktualisiert..." | tee -a "$LOG"
sudo apt update && sudo apt upgrade -y && sudo apt dist-upgrade -y

# üì• Kernel ggf. erweitern
if [[ "$UBUNTU" == "22.04" ]]; then
    echo "üì• Installiere HWE-Kernel f√ºr 22.04" | tee -a "$LOG"
    sudo apt install --install-recommends linux-generic-hwe-22.04 -y
elif [[ "$UBUNTU" == "24.04" ]]; then
    echo "üì• Kernel ist aktuell f√ºr Ubuntu 24.04" | tee -a "$LOG"
fi

echo "‚úÖ Skript abgeschlossen. Details siehe ‚Üí $LOG"
